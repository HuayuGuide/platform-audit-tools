# hg-audit-system V2 需求规格说明书（可执行版）

版本：V2.0-RS2  
状态：待确认后执行  
适用范围：`huayuguide.com` 实测数据插件重构

---

## 1. 产品定位与目标

### 1.1 产品定位

`hg-audit-system` 是 **实测数据内容中心**，不是纯展示插件。  
核心价值是把一手实测数据转化为可复用、可查询、可展示、可用于 SEO 的结构化资产。

### 1.2 业务目标

1. 支撑海外华人用户快速判断“平台资金风险与出金效率”。
2. 支撑站点持续输出基于实测数据的 SEO 内容。
3. 保证数据可调用能力，后续任意页面可按规则组合取数。

### 1.3 非目标

1. 本期不做自动批量发布页面。
2. 本期不做视觉改版优先工程。
3. 本期不做与核心数据无关的功能扩张。

---

## 2. 核心用户与真实痛点

### 2.1 目标用户

海外华人出入金用户，重点关注：
1. 提款速度
2. 汇率损耗
3. KYC 强度

### 2.2 用户决策问题

1. 这个平台能不能顺利提款？
2. 提款到底快不快？
3. 有没有汇率暗扣？
4. 会不会突然触发高强度 KYC？

---

## 3. 需求总览（P0/P1）

### 3.0 核心能力三角（必须同时达标）

1. 逻辑缜密  
同一输入永远得到同一输出；规则可追踪；异常有稳定兜底。

2. 性能优秀  
前台读取快、后台处理稳、查询可缓存，数据量增长后仍可控。

3. 易用性高  
录入后能获得清晰可理解的智能反馈，减少人工判断负担。

### 3.1 P0 需求（必须）

1. 数据资产优先  
所有实测记录必须标准化存储，可稳定查询。

2. 可调用优先  
必须支持明确查询场景，例如“提款最快的 5 大平台”。

3. 性能优先  
前台读取不做重计算，优先读取预计算与缓存结果。

4. 易用优先  
后台录入减少人工算错，异常字段有可见提示和安全兜底。

5. SEO 资产优先  
结构化数据与页面核心结论必须由实测数据驱动。

6. 智能大脑优先  
实测数据输入后，系统必须自动完成判断、清洗、标记、加工、存储和可调用输出。

### 3.2 P1 需求（应做）

1. 统一查询契约  
形成可扩展的数据查询接口，便于后续新增榜单维度。

2. 运维可观测  
汇率链路与关键计算有可追踪状态和失败兜底。

3. 兼容演进  
对现有短码与展示能力保持向后兼容。

---

## 4. 功能需求（可执行条目）

### FR-01 实测记录标准化

1. 系统必须把每条 `audit_record` 的关键字段转为稳定可读值。
2. 必填关键域：平台关联、状态、提款耗时、币种/金额、KYC状态。
3. 字段缺失时不得报错，必须返回降级值。

验收标准：
1. 缺任何单一字段时不发生 Fatal Error。
2. 关键字段读取失败时有默认输出文案。

### FR-02 统一数据查询能力

1. 系统必须提供统一查询入口（PHP 调用优先）。
2. 首批必须支持 `withdraw_speed` 查询维度。
3. 查询参数至少包含：`limit`、`min_samples`。

验收标准：
1. 能在模板中一行调用“提款最快 5 大平台”。
2. 返回结果包含平台 ID、名称、样本数、平均耗时、最快耗时。

### FR-03 前台读链路性能保护

1. 前台渲染禁止执行重业务计算。
2. 必须优先读取预计算结果和缓存。
3. 缓存失效必须可控，不能无限脏读。

验收标准：
1. 短码渲染 P95 小于 80ms。
2. 同页重复渲染不重复做重查询。

### FR-04 后台录入易用性

1. 后台输入后必须获得实时计算提示（由后端计算返回）。
2. 提示内容至少包括：速度标签、汇率偏差、风险提醒。
3. 无效输入时给出用户可读错误提示。

验收标准：
1. 常见录入错误可在提交前发现。
2. 空字段不导致后台卡死或死循环。

### FR-05 SEO 数据输出

1. 动态 FAQ/Review 的结构化数据必须由实测数据生成。
2. SEO 标题必须带实测关键信息（耗时/KYC等）。
3. 输出失败时必须降级，不阻塞主页面渲染。

验收标准：
1. 页面存在合法 JSON-LD。
2. 无数据时输出可解释的降级内容。

### FR-06 智能大脑处理流水线

1. 输入后自动执行：  
`采集 -> 清洗 -> 校验 -> 规则判断 -> 风险标记 -> 存储 -> 索引 -> 可调用输出`
2. 每个环节可独立测试，任一环节异常不导致整链路崩溃。
3. 处理结果可追溯（至少包含处理时间、规则版本、关键输入摘要）。

验收标准：
1. 同一输入重复处理得到一致结果（幂等）。
2. 脏数据输入返回稳定降级结果，不出现 Fatal Error。
3. 查询“提款最快 TopN”不依赖人工修补数据。

### FR-07 自动判断 / 自动清洗 / 自动标记

1. 自动判断：  
自动推导速度等级、汇率损耗等级、KYC强度等级、基础风险分。
2. 自动清洗：  
统一币种别名、时间格式、数字格式、空值/非法值。
3. 自动标记：  
自动写入风险标签、特征标签和查询索引标签。

验收标准：
1. 同义币种输入（如 `RMB/CNY`）输出同一标准值。
2. 时间/金额异常输入有标准化结果或可解释空值。
3. 标签可直接用于后续查询与筛选。

---

## 5. 数据查询契约（V2 最小版）

### 5.1 查询入口（PHP）

函数：`hg_audit_query_data(array $args = [])`  
参数：
1. `metric`：默认 `withdraw_speed`
2. `limit`：默认 `5`
3. `min_samples`：默认 `1`

返回结构：
1. `metric`
2. `limit`
3. `min_samples`
4. `count`
5. `generated_at`
6. `rows[]`

`rows[]` 字段：
1. `rank`
2. `platform_id`
3. `platform_name`
4. `platform_url`
5. `sample_count`
6. `avg_duration_min`
7. `fastest_duration_min`
8. `avg_duration_text`
9. `fastest_duration_text`

### 5.2 快捷函数

函数：`hg_audit_get_top_platforms_by_speed(int $limit = 5, int $min_samples = 1): array`

用途：
直接获取“提款最快 Top N 平台”。

---

## 6. 非功能需求

### 6.1 性能

1. `audit_log` 短码 P95 小于 80ms。
2. 查询结果支持缓存，默认缓存 12 小时。
3. 请求级缓存避免同请求重复计算。

### 6.1.1 智能处理性能

1. 单条记录智能处理目标：P95 < 300ms（外部汇率超时时走降级链路）。
2. TopN 查询接口目标：P95 < 120ms（命中缓存时）。

### 6.2 稳定性

1. 任意外部汇率异常不得导致整页崩溃。
2. 字段脏值必须通过防御性转换处理。

### 6.2.1 逻辑一致性

1. 规则引擎必须确定性（deterministic），禁止随机分支结论。
2. 关键规则版本化，避免“同数据不同时期结论不可解释”。

### 6.3 安全性

1. 所有输出做转义。
2. 对外接口默认最小开放原则。

### 6.4 易用性

1. 后台录入后一次反馈即可理解核心结论。
2. 错误提示必须业务可读，不堆技术术语。
3. 缺字段时提示“缺什么、影响什么、如何补齐”。

---

## 7. 约束与原则

1. 先需求后设计后编码。
2. 禁止为“架构好看”牺牲业务交付。
3. 插件首要目标是数据可用性，不是功能炫技。
4. 所有新增能力必须回答一个问题：是否增强了“数据可调用”。

---

## 8. 里程碑与执行顺序

### M1 数据契约固化

1. 固化查询接口与返回结构。
2. 完成“提款最快 Top N”能力。

完成标准：
1. 模板可直接调用。
2. 查询结果稳定并有缓存。

### M2 读链路性能收敛

1. 前台渲染优先读预计算。
2. 减少渲染时查询与计算。

完成标准：
1. P95 达标。
2. 无功能回归。

### M3 录入体验与数据质量

1. 强化后台录入提示与校验。
2. 降低错误数据进入率。

完成标准：
1. 录入错误可提前识别。
2. 核心字段完整率提升。

---

## 9. 验收清单（上线前）

1. 能稳定输出“提款最快的 5 大平台”结果。
2. 前台短码在目标数据量下性能达标。
3. JSON-LD 与 SEO 标题可正常输出。
4. 后台录入无卡死、无循环触发。
5. 插件升级后原有短码保持可用。

---

## 10. 决策记录（本期共识）

1. 数据资产第一优先级。
2. 不走自动发页极端路线。
3. 先把数据能力做实，再决定页面策略。
